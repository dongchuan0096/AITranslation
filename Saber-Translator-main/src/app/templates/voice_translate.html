<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è¯­éŸ³ç¿»è¯‘ - Saber-Translator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #voiceText { width: 60%; min-height: 80px; margin-bottom: 10px; }
        #result { margin-top: 20px; font-size: 1.2em; color: #333; }
        .input-row { margin-bottom: 10px; }
        #voiceStatus { color: #007bff; margin-left: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/langdetect@1.1.0/langdetect.min.js"></script>
</head>
<body>
    <h2>è¯­éŸ³è¾“å…¥ç¿»è¯‘</h2>
    <div class="input-row">
        <button id="voiceBtn">ğŸ¤ å¼€å§‹è¯­éŸ³è¾“å…¥</button>
        <span id="voiceStatus"></span>
    </div>
    <div class="input-row">
        <label>è¯†åˆ«å†…å®¹ï¼š</label><br>
        <textarea id="voiceText" placeholder="è¯­éŸ³è¯†åˆ«å†…å®¹ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ"></textarea>
    </div>
    <div class="input-row">
        <label>è‡ªåŠ¨è¯†åˆ«è¯­è¨€ï¼š</label>
        <span id="detectedLang" style="font-weight:bold; color:#007bff;">-</span>
    </div>
    <div class="input-row">
        <label>ç›®æ ‡è¯­è¨€ï¼š</label>
        <select id="targetLang">
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">è‹±æ–‡</option>
            <option value="ja">æ—¥æ–‡</option>
            <option value="ko">éŸ©æ–‡</option>
        </select>
    </div>
    <div class="input-row">
        <label>æœåŠ¡å•†ï¼š</label>
        <input id="modelProvider" value="deepseek" />
        <label>æ¨¡å‹åï¼š</label>
        <input id="modelName" value="deepseek-chat" placeholder="å¦‚ silicon-llava2-34b" />
        <label>API Keyï¼š</label>
        <input id="apiKey" value="" placeholder="ä½ çš„API KEY" />
    </div>
    <div id="result"></div>
    <script>
        function langCodeToName(code) {
            const map = {zh: 'ä¸­æ–‡', en: 'è‹±æ–‡', ja: 'æ—¥æ–‡', ko: 'éŸ©æ–‡'};
            return map[code] || code;
        }
        async function detectAndTranslate() {
            const text = document.getElementById('voiceText').value.trim();
            const target_language = document.getElementById('targetLang').value;
            const model_provider = document.getElementById('modelProvider').value;
            const api_key = document.getElementById('apiKey').value;
            const model_name = document.getElementById('modelName').value;
            if (!text) {
                document.getElementById('detectedLang').innerText = '-';
                document.getElementById('result').innerText = '';
                return;
            }
            let detected = 'unknown';
            try {
                detected = langdetect.detectOne(text);
            } catch(e) {}
            document.getElementById('detectedLang').innerText = langCodeToName(detected);
            if (detected === target_language) {
                document.getElementById('result').innerText = 'æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ç›¸åŒï¼Œæ— éœ€ç¿»è¯‘ã€‚';
                return;
            }
            document.getElementById('result').innerText = 'ç¿»è¯‘ä¸­...';
            const res = await fetch('/api/translate_single_text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    original_text: text,
                    target_language,
                    model_provider,
                    api_key,
                    model_name,
                    source_language: detected
                })
            });
            const data = await res.json();
            document.getElementById('result').innerText = data.translated_text || data.error || 'ç¿»è¯‘å¤±è´¥';
        }
        document.getElementById('voiceText').addEventListener('input', function() {
            detectAndTranslate();
        });
        document.getElementById('targetLang').addEventListener('change', function() {
            detectAndTranslate();
        });
        // è¯­éŸ³è¯†åˆ«åŠŸèƒ½
        let recognition = null;
        let recognizing = false;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; // å¯æ ¹æ®éœ€è¦è®¾ç½®
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onstart = function() {
                recognizing = true;
                document.getElementById('voiceStatus').innerText = 'æ­£åœ¨è†å¬...';
                document.getElementById('voiceBtn').disabled = true;
            };
            recognition.onend = function() {
                recognizing = false;
                document.getElementById('voiceStatus').innerText = '';
                document.getElementById('voiceBtn').disabled = false;
            };
            recognition.onerror = function(e) {
                recognizing = false;
                document.getElementById('voiceStatus').innerText = 'è¯­éŸ³è¯†åˆ«å¤±è´¥';
                document.getElementById('voiceBtn').disabled = false;
            };
            recognition.onresult = function(event) {
                let transcript = '';
                for (let i = 0; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                }
                document.getElementById('voiceText').value = transcript;
                detectAndTranslate();
            };
            document.getElementById('voiceBtn').onclick = function() {
                if (!recognizing) {
                    recognition.start();
                }
            };
        } else {
            document.getElementById('voiceBtn').disabled = true;
            document.getElementById('voiceStatus').innerText = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«';
        }
    </script>
</body>
</html> 